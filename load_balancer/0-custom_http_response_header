#!/usr/bin/env bash
# 0-custom_http_response_header
# Configures Nginx to return a custom X-Served-By header automatically detecting the hostname

# Detect hostname automatically (or fallback if hostname can't be changed)
HOSTNAME=$(hostname 2>/dev/null || echo "web-01")

# Nginx config path
NGINX_CONF="/etc/nginx/sites-available/default"

# Backup config if not already backed up
[ ! -f "${NGINX_CONF}.bak" ] && cp "$NGINX_CONF" "${NGINX_CONF}.bak"

# Remove any existing X-Served-By lines to prevent duplicates
sed -i '/add_header X-Served-By/d' "$NGINX_CONF"

# Add the header inside the server block
sed -i "/server_name _;/a \ \ add_header X-Served-By $HOSTNAME always;" "$NGINX_CONF"

# Test configuration and reload Nginx
nginx -t && nginx -s reload

echo "Custom header X-Served-By set to: $HOSTNAME"
