#!/usr/bin/env bash
# 0-custom_http_response_header
# Configure Nginx on a new Ubuntu machine to add X-Served-By header

# Ignore SC2154 for ShellCheck
# shellcheck disable=SC2154

# Update package list and install Nginx
apt-get update -y
apt-get install -y nginx

# Ensure Nginx service is running
systemctl enable nginx
systemctl start nginx

# Get the hostname of the server
hostname_value=$(hostname)

# Add custom header X-Served-By in the default Nginx configuration
nginx_conf="/etc/nginx/sites-available/default"

# Backup original configuration
cp "$nginx_conf" "${nginx_conf}.bak"

# Insert header configuration inside the server block
# This ensures the header is added to all HTTP responses
sed -i "/server_name _;/a \ \ add_header X-Served-By $hostname_value;" "$nginx_conf"

# Test Nginx configuration and reload
nginx -t && systemctl reload nginx
