#!/usr/bin/env bash
# Debugging version to fix X-Served-By header

sudo apt-get update -y
sudo apt-get install -y nginx curl

# Completely reset nginx configuration
sudo systemctl stop nginx

# Create a minimal, clean configuration
sudo bash -c "cat > /etc/nginx/nginx.conf << 'EOF'
user www-data;
worker_processes auto;
pid /run/nginx.pid;

events {
    worker_connections 768;
}

http {
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        
        root /var/www/html;
        index index.html index.htm;
        
        server_name _;
        
        location / {
            add_header X-Served-By web-62 always;
            try_files \$uri \$uri/ =404;
        }
    }
}
EOF"

# Test and start
sudo nginx -t && sudo systemctl start nginx

# Comprehensive test
echo "=== Testing Headers ==="
curl -I http://localhost/
echo "=== X-Served-By Header ==="
curl -I http://localhost/ | grep -i "x-served-by"
